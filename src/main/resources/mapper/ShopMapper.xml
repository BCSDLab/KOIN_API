<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="koreatech.in.repository.ShopMapper">
    <update id="deleteAllForInvolvedWithMenuForAdmin">
        UPDATE (
            koin.shop_menus sm

            LEFT JOIN koin.shop_menu_details smd
            ON sm.id = smd.shop_menu_id

            LEFT JOIN koin.shop_menu_images smi
            ON sm.id = smi.shop_menu_id

            LEFT JOIN koin.shop_menu_category_map smcm
            ON sm.id = smcm.shop_menu_id
        )
        SET
            sm.is_deleted = 1,
            smd.is_deleted = 1,
            smi.is_deleted = 1,
            smcm.is_deleted = 1
        WHERE
            sm.id = #{shopMenuId}
    </update>

    <insert id="createMenuImagesForAdmin" parameterType="list">
        INSERT INTO koin.shop_menu_images
        (shop_menu_id, image_url)
        VALUES
        <foreach collection="shopMenuImages" item="item" separator=",">
            (
                #{item.shop_menu_id},
                #{item.image_url}
            )
        </foreach>
    </insert>

    <insert id="createMenuDetailsForAdmin" parameterType="list">
        INSERT INTO koin.shop_menu_details
        (shop_menu_id, `option`, price)
        VALUES
        <foreach collection="shopMenuDetails" item="item" separator=",">
            (
                #{item.shop_menu_id},
                #{item.option},
                #{item.price}
            )
        </foreach>
    </insert>

    <insert id="createMenuCategoryMapsForAdmin" parameterType="list">
        INSERT INTO koin.shop_menu_category_map
        (shop_menu_id, shop_menu_category_id)
        VALUES
        <foreach collection="shopMenuCategoryMaps" item="item" separator=",">
            (
                #{item.shop_menu_id},
                #{item.shop_menu_category_id}
            )
        </foreach>
    </insert>

    <update id="deleteMenuDetailsForAdmin" parameterType="list">
        <foreach collection="shopMenuDetails" item="item" separator=";">
            UPDATE koin.shop_menu_details
            SET is_deleted = 1
            WHERE id = #{item.id}
        </foreach>
    </update>

    <update id="deleteMenuCategoryMapsForAdmin" parameterType="list">
        <foreach collection="shopMenuCategoryMaps" item="item" separator=";">
            UPDATE koin.shop_menu_category_map
            SET is_deleted = 1
            WHERE
                shop_menu_id = #{item.shop_menu_id}
                AND shop_menu_category_id = #{item.shop_menu_category_id}
        </foreach>
    </update>

    <insert id="createShopOpensForAdmin" parameterType="list">
        INSERT INTO koin.shop_opens
        (shop_id, day_of_week, closed, open_time, close_time)
        VALUES
        <foreach collection="shopOpens" item="item" separator=",">
            <choose>
                <when test="item.closed">
                    (
                        #{item.shop_id},
                        #{item.day_of_week},
                        #{item.closed},
                        null,
                        null
                    )
                </when>
                <otherwise>
                    (
                        #{item.shop_id},
                        #{item.day_of_week},
                        #{item.closed},
                        #{item.open_time},
                        #{item.close_time}
                    )
                </otherwise>
            </choose>
        </foreach>
    </insert>

    <insert id="createShopCategoryMapsForAdmin" parameterType="list">
        INSERT INTO koin.shop_category_map
        (shop_id, shop_category_id)
        VALUES
        <foreach collection="shopCategoryMaps" item="item" separator=",">
            (
                #{item.shop_id},
                #{item.shop_category_id}
            )
        </foreach>
    </insert>

    <insert id="createMenuCategoriesForAdmin" parameterType="list">
        INSERT INTO koin.shop_menu_categories
        (shop_id, `name`)
        VALUES
        <foreach collection="shopMenuCategories" item="item" separator=",">
            (
                #{item.shop_id},
                #{item.name}
            )
        </foreach>
    </insert>

    <update id="updateShopOpensForAdmin" parameterType="list">
        <foreach collection="shopOpens" item="item" separator=";">
            UPDATE koin.shop_opens
            SET
                closed = #{item.closed},
                <choose>
                    <when test="item.closed">
                        open_time = null,
                        close_time = null
                    </when>
                    <otherwise>
                        open_time = #{item.open_time},
                        close_time = #{item.close_time}
                    </otherwise>
                </choose>
            WHERE
                shop_id = #{item.shop_id}
                AND day_of_week = #{item.day_of_week}
                AND is_deleted = 0
        </foreach>
    </update>

    <update id="deleteShopCategoryMapsForAdmin" parameterType="list">
        <foreach collection="shopCategoryMaps" item="item" separator=";">
            UPDATE koin.shop_category_map
            SET is_deleted = 1
            WHERE
                shop_id = #{item.shop_id}
                AND shop_category_id = #{item.shop_category_id}
        </foreach>
    </update>

    <insert id="createShopImagesForAdmin" parameterType="list">
        INSERT INTO koin.shop_images
        (shop_id, image_url)
        VALUES
        <foreach collection="shopImages" item="item" separator=",">
            (
                #{item.shop_id},
                #{item.image_url}
            )
        </foreach>
    </insert>

    <update id="deleteShopImagesForAdmin" parameterType="list">
        <foreach collection="shopImages" item="item" separator=";">
            UPDATE koin.shop_images
            SET is_deleted = 1
            WHERE
                shop_id = #{item.shop_id}
                AND image_url = #{item.image_url}
        </foreach>
    </update>

    <update id="deleteMenuImagesForAdmin" parameterType="list">
        <foreach collection="shopMenuImages" item="item" separator=";">
            UPDATE koin.shop_menu_images
            SET is_deleted = 1
            WHERE
                shop_menu_id = #{item.shop_menu_id}
                AND image_url = #{item.image_url}
        </foreach>
    </update>
</mapper>