<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="koreatech.in.repository.query.ShopQueryMapper">
    <!-- Menu in MenuResponse For Admin -->
    <select id="getMenuInMenuResponseForAdmin" resultMap="Admin/MenuResponse/Menu">
        SELECT
            # shop_menus
            t1.id AS `shop_menus.id`,
            t1.shop_id AS `shop_menus.shop_id`,
            t1.name AS `shop_menus.name`,
            t1.is_hidden AS `shop_menus.is_hidden`,
            t1.description AS `shop_menus.description`,

            # shop_menu_details
            t2.option AS `shop_menu_details.option`,
            t2.price AS `shop_menu_details.price`,

            # shop_menu_images
            t3.image_url AS `shop_menu_images.image_url`,

            # shop_menu_categories
            t5.id AS `shop_menu_categories.id`

        FROM (
            # shop_menus
            SELECT *
            FROM koin.shop_menus
            WHERE
                id = #{shopMenuId}
                AND is_deleted = 0
        ) t1

            # shop_menus : shop_menu_details (1:N)
            LEFT JOIN koin.shop_menu_details t2
            ON
                t1.id = t2.shop_menu_id
                AND t2.is_deleted = 0

            # shop_menus : shop_menu_images (1:N)
            LEFT JOIN koin.shop_menu_images t3
            ON
                t1.id = t3.shop_menu_id
                AND t3.is_deleted = 0

            # relation table between shop_menus and shop_menu_categories
            LEFT JOIN koin.shop_menu_category_map t4
            ON
                t1.id = t4.shop_menu_id
                AND t4.is_deleted = 0

            # shop_menus : shop_menu_categories (N:M)
            LEFT JOIN koin.shop_menu_categories t5
            ON
                t4.shop_menu_category_id = t5.id
                AND t5.is_deleted = 0
    </select>

    <resultMap id="Admin/MenuResponse/Menu" type="koreatech.in.dto.shop.admin.response.MenuResponse$Menu">
        <id property="id" column="shop_menus.id"/>
        <result property="shop_id" column="shop_menus.shop_id"/>
        <result property="name" column="shop_menus.name"/>
        <result property="is_hidden" column="shop_menus.is_hidden"/>
        <result property="description" column="shop_menus.description"/>

        <collection property="option_prices" javaType="list" ofType="koreatech.in.dto.shop.admin.response.MenuResponse$Menu$OptionPrice">
            <result property="option" column="shop_menu_details.option"/>
            <result property="price" column="shop_menu_details.price"/>
        </collection>

        <collection property="image_urls" javaType="list" ofType="string">
            <result property="image_url" column="shop_menu_images.image_url"/>
        </collection>

        <collection property="category_ids" javaType="list" ofType="integer">
            <id property="id" column="shop_menu_categories.id"/>
        </collection>
    </resultMap>


    <!-- Shop in ShopResponse For Admin -->
    <select id="getShopInShopResponseForAdmin" resultMap="Admin/ShopResponse/Shop">
        SELECT
            # shops
            t1.id AS `shops.id`,
            t1.name AS `shops.name`,
            t1.phone AS `shops.phone`,
            t1.address AS `shops.address`,
            t1.description AS `shops.description`,
            t1.delivery AS `shops.delivery`,
            t1.delivery_price AS `shops.delivery_price`,
            t1.pay_card AS `shops.pay_card`,
            t1.pay_bank AS `shops.pay_bank`,
            t1.is_deleted AS `shops.is_deleted`,

            # shop_opens
            t2.day_of_week AS `shop_opens.day_of_week`,
            t2.closed AS `shop_opens.closed`,
            t2.open_time AS `shop_opens.open_time`,
            t2.close_time AS `shop_opens.close_time`,

            # shop_images
            t3.image_url AS `shop_images.image_url`,

            # shop_menu_categories
            t4.id AS `shop_menu_categories.id`,
            t4.name AS `shop_menu_categories.name`,

            # shop_categories
            t6.id AS `shop_categories.id`,
            t6.name AS `shop_categories.name`,

            # shop_menus
            t7.id AS `shop_menus.id`,
            t7.name AS `shop_menus.name`,
            t7.is_hidden AS `shop_menus.is_hidden`,
            t7.description AS `shop_menus.description`,

            # shop_menu_details
            t8.`option` AS `shop_menu_details.option`,
            t8.price AS `shop_menu_details.price`,

            # shop_menu_images
            t9.image_url AS `shop_menu_images.image_url`,

            # shop_menu_categories
            t11.id AS `shop_menu_categories_2nd.id`

        FROM (
            # shops
            SELECT *
            FROM koin.shops
            WHERE id = #{shopId}
        ) t1

            # shops : shop_opens (1:N)
            LEFT JOIN koin.shop_opens t2
            ON
                t1.id = t2.shop_id
                AND t2.is_deleted = 0

            # shops : shop_images (1:N)
            LEFT JOIN koin.shop_images t3
            ON
                t1.id = t3.shop_id
                AND t3.is_deleted = 0

            # shops : shop_menu_categories (1:N)
            LEFT JOIN koin.shop_menu_categories t4
            ON
                t1.id = t4.shop_id
                AND t4.is_deleted = 0

            # relation table between shops and shop_categories
            LEFT JOIN koin.shop_category_map t5
            ON
                t1.id = t5.shop_id
                AND t5.is_deleted = 0

            # shops : shop_categories (N:M)
            LEFT JOIN koin.shop_categories t6
            ON
                t5.shop_category_id = t6.id
                AND t6.is_deleted = 0

            # shops : shop_menus (1:N)
            LEFT JOIN koin.shop_menus t7
            ON
                t1.id = t7.shop_id
                AND t7.is_deleted = 0

            # shop_menus : shop_menu_details (1:N)
            LEFT JOIN koin.shop_menu_details t8
            ON
                t7.id = t8.shop_menu_id
                AND t8.is_deleted = 0

            # shop_menus : shop_menu_images (1:N)
            LEFT JOIN koin.shop_menu_images t9
            ON
                t7.id = t9.shop_menu_id
                AND t9.is_deleted = 0

            # relation table between shop_menus and shop_menu_categories
            LEFT JOIN koin.shop_menu_category_map t10
            ON
                t7.id = t10.shop_menu_id
                AND t10.is_deleted = 0

            # shop_menus : shop_menu_categories (N:M)
            LEFT JOIN koin.shop_menu_categories t11
            ON
                t10.shop_menu_category_id = t11.id
                AND t11.is_deleted = 0
    </select>

    <resultMap id="Admin/ShopResponse/Shop" type="koreatech.in.dto.shop.admin.response.ShopResponse$Shop">
        <id property="id" column="shops.id"/>
        <result property="name" column="shops.name"/>
        <result property="phone" column="shops.phone"/>
        <result property="address" column="shops.address"/>
        <result property="description" column="shops.description"/>
        <result property="delivery" column="shops.delivery"/>
        <result property="delivery_price" column="shops.delivery_price"/>
        <result property="pay_card" column="shops.pay_card"/>
        <result property="pay_bank" column="shops.pay_bank"/>
        <result property="is_deleted" column="shops.is_deleted"/>

        <collection property="open" javaType="list" ofType="koreatech.in.dto.shop.admin.response.ShopResponse$Shop$Open">
            <result property="day_of_week" column="shop_opens.day_of_week" />
            <result property="closed" column="shop_opens.closed"/>
            <result property="open_time" column="shop_opens.open_time" />
            <result property="close_time" column="shop_opens.close_time"/>
        </collection>

        <collection property="image_urls" javaType="list" ofType="string">
            <result property="image_url" column="shop_images.image_url"/>
        </collection>

        <collection property="menu_categories" javaType="list" ofType="koreatech.in.dto.shop.admin.response.ShopResponse$Shop$MenuCategory">
            <id property="id" column="shop_menu_categories.id"/>
            <result property="name" column="shop_menu_categories.name"/>
        </collection>

        <collection property="shop_categories" javaType="list" ofType="koreatech.in.dto.shop.admin.response.ShopResponse$Shop$ShopCategory">
            <id property="id" column="shop_categories.id"/>
            <result property="name" column="shop_categories.name"/>
        </collection>

        <collection property="menus" javaType="list" ofType="koreatech.in.dto.shop.admin.response.ShopResponse$Shop$Menu">
            <id property="id" column="shop_menus.id"/>
            <result property="name" column="shop_menus.name"/>
            <result property="is_hidden" column="shop_menus.is_hidden"/>
            <result property="description" column="shop_menus.description"/>

            <collection property="option_prices" javaType="list" ofType="koreatech.in.dto.shop.admin.response.ShopResponse$Shop$Menu$OptionPrice">
                <result property="option" column="shop_menu_details.option"/>
                <result property="price" column="shop_menu_details.price"/>
            </collection>

            <collection property="image_urls" javaType="list" ofType="string">
                <result property="image_url" column="shop_menu_images.image_url"/>
            </collection>

            <collection property="category_ids" javaType="list" ofType="integer">
                <id property="category_id" column="shop_menu_categories_2nd.id"/>
            </collection>
        </collection>
    </resultMap>


    <!-- Menus in AllMenusOfShopResponse For Admin -->
    <select id="getMenusInAllMenusOfShopResponseForAdmin" resultMap="Admin/AllMenusOfShopResponse/Menu">
        SELECT
            # shop_menus
            t1.id AS `shop_menus.id`,
            t1.`name` AS `shop_menus.name`,
            t1.is_hidden AS `shop_menus.is_hidden`,

            # shop_menu_details
            t2.`option` AS `shop_menu_details.option`,
            t2.price AS `shop_menu_details.price`,

            # shop_menu_categories
            t4.id AS `shop_menu_categories.id`

        FROM (
            # shop_menus
            SELECT *
            FROM koin.shop_menus
            WHERE
                shop_id = #{shopId}
                AND is_deleted = 0
        ) t1

        # shop_menus : shop_menu_details (1:N)
        LEFT JOIN koin.shop_menu_details t2
        ON
            t1.id = t2.shop_menu_id
            AND t2.is_deleted = 0

        # relation table between shop_menus and shop_menu_categories
        LEFT JOIN koin.shop_menu_category_map t3
        ON
            t1.id = t3.shop_menu_id
            AND t3.is_deleted = 0

        # shop_menus : shop_menu_categories (N:M)
        LEFT JOIN koin.shop_menu_categories t4
        ON
            t3.shop_menu_category_id = t4.id
            AND t4.is_deleted = 0

    </select>

    <resultMap id="Admin/AllMenusOfShopResponse/Menu" type="koreatech.in.dto.shop.admin.response.AllMenusOfShopResponse$Menu">
        <id property="id" column="shop_menus.id"/>
        <result property="name" column="shop_menus.name"/>
        <result property="is_hidden" column="shop_menus.is_hidden"/>

        <collection property="option_prices" javaType="list" ofType="koreatech.in.dto.shop.admin.response.AllMenusOfShopResponse$Menu$OptionPrice">
            <result property="option" column="shop_menu_details.option"/>
            <result property="price" column="shop_menu_details.price"/>
        </collection>

        <collection property="category_ids" javaType="list" ofType="integer">
            <result property="category_id" column="shop_menu_categories.id"/>
        </collection>
    </resultMap>

    <!-- Shop in ShopResponse -->
    <select id="getShopInShopResponse" resultMap="Normal/ShopResponse/Shop">
        SELECT
            # shops
            t1.id AS `shops.id`,
            t1.name AS `shops.name`,
            t1.phone AS `shops.phone`,
            t1.address AS `shops.address`,
            t1.description AS `shops.description`,
            t1.delivery AS `shops.delivery`,
            t1.delivery_price AS `shops.delivery_price`,
            t1.pay_card AS `shops.pay_card`,
            t1.pay_bank AS `shops.pay_bank`,
            t1.is_deleted AS `shops.is_deleted`,

            # shop_opens
            t2.day_of_week AS `shop_opens.day_of_week`,
            t2.closed AS `shop_opens.closed`,
            t2.open_time AS `shop_opens.open_time`,
            t2.close_time AS `shop_opens.close_time`,

            # shop_images
            t3.image_url AS `shop_images.image_url`,

            # shop_menu_categories
            t4.id AS `shop_menu_categories.id`,
            t4.name AS `shop_menu_categories.name`,

            # shop_categories
            t6.id AS `shop_categories.id`,
            t6.name AS `shop_categories.name`,

            # shop_menus
            t7.id AS `shop_menus.id`,
            t7.name AS `shop_menus.name`,
            t7.is_hidden AS `shop_menus.is_hidden`,
            t7.description AS `shop_menus.description`,

            # shop_menu_details
            t8.`option` AS `shop_menu_details.option`,
            t8.price AS `shop_menu_details.price`,

            # shop_menu_images
            t9.image_url AS `shop_menu_images.image_url`,

            # shop_menu_categories
            t11.id AS `shop_menu_categories_2nd.id`

        FROM (
            # shops
            SELECT *
            FROM koin.shops
            WHERE
                id = #{shopId}
                AND is_deleted = 0
        ) t1

        # shops : shop_opens (1:N)
        LEFT JOIN koin.shop_opens t2
        ON
            t1.id = t2.shop_id
            AND t2.is_deleted = 0

        # shops : shop_images (1:N)
        LEFT JOIN koin.shop_images t3
        ON
            t1.id = t3.shop_id
            AND t3.is_deleted = 0

        # shops : shop_menu_categories (1:N)
        LEFT JOIN koin.shop_menu_categories t4
        ON
            t1.id = t4.shop_id
            AND t4.is_deleted = 0

        # relation table between shops and shop_categories
        LEFT JOIN koin.shop_category_map t5
        ON
            t1.id = t5.shop_id
            AND t5.is_deleted = 0

        # shops : shop_categories (N:M)
        LEFT JOIN koin.shop_categories t6
        ON
            t5.shop_category_id = t6.id
            AND t6.is_deleted = 0

        # shops : shop_menus (1:N)
        LEFT JOIN koin.shop_menus t7
        ON
            t1.id = t7.shop_id
            AND t7.is_deleted = 0

        # shop_menus : shop_menu_details (1:N)
        LEFT JOIN koin.shop_menu_details t8
        ON
            t7.id = t8.shop_menu_id
            AND t8.is_deleted = 0

        # shop_menus : shop_menu_images (1:N)
        LEFT JOIN koin.shop_menu_images t9
        ON
            t7.id = t9.shop_menu_id
            AND t9.is_deleted = 0

        # relation table between shop_menus and shop_menu_categories
        LEFT JOIN koin.shop_menu_category_map t10
        ON
            t7.id = t10.shop_menu_id
            AND t10.is_deleted = 0

        # shop_menus : shop_menu_categories (N:M)
        LEFT JOIN koin.shop_menu_categories t11
        ON
            t10.shop_menu_category_id = t11.id
            AND t11.is_deleted = 0
    </select>

    <resultMap id="Normal/ShopResponse/Shop" type="koreatech.in.dto.shop.normal.response.ShopResponse$Shop">
        <id property="id" column="shops.id"/>
        <result property="name" column="shops.name"/>
        <result property="phone" column="shops.phone"/>
        <result property="address" column="shops.address"/>
        <result property="description" column="shops.description"/>
        <result property="delivery" column="shops.delivery"/>
        <result property="delivery_price" column="shops.delivery_price"/>
        <result property="pay_card" column="shops.pay_card"/>
        <result property="pay_bank" column="shops.pay_bank"/>

        <collection property="open" javaType="list" ofType="koreatech.in.dto.shop.normal.response.ShopResponse$Shop$Open">
            <result property="day_of_week" column="shop_opens.day_of_week" />
            <result property="closed" column="shop_opens.closed"/>
            <result property="open_time" column="shop_opens.open_time" />
            <result property="close_time" column="shop_opens.close_time"/>
        </collection>

        <collection property="image_urls" javaType="list" ofType="string">
            <result property="image_url" column="shop_images.image_url"/>
        </collection>

        <collection property="menu_categories" javaType="list" ofType="koreatech.in.dto.shop.normal.response.ShopResponse$Shop$MenuCategory">
            <id property="id" column="shop_menu_categories.id"/>
            <result property="name" column="shop_menu_categories.name"/>
        </collection>

        <collection property="shop_categories" javaType="list" ofType="koreatech.in.dto.shop.normal.response.ShopResponse$Shop$ShopCategory">
            <id property="id" column="shop_categories.id"/>
            <result property="name" column="shop_categories.name"/>
        </collection>

        <collection property="menus" javaType="list" ofType="koreatech.in.dto.shop.normal.response.ShopResponse$Shop$Menu">
            <id property="id" column="shop_menus.id"/>
            <result property="name" column="shop_menus.name"/>
            <result property="is_hidden" column="shop_menus.is_hidden"/>
            <result property="description" column="shop_menus.description"/>

            <collection property="option_prices" javaType="list" ofType="koreatech.in.dto.shop.normal.response.ShopResponse$Shop$Menu$OptionPrice">
                <result property="option" column="shop_menu_details.option"/>
                <result property="price" column="shop_menu_details.price"/>
            </collection>

            <collection property="image_urls" javaType="list" ofType="string">
                <result property="image_url" column="shop_menu_images.image_url"/>
            </collection>

            <collection property="category_ids" javaType="list" ofType="integer">
                <id property="category_id" column="shop_menu_categories_2nd.id"/>
            </collection>
        </collection>
    </resultMap>


    <!-- Shop in AllShopsResponse -->
    <select id="getShopsInAllShopsResponse" resultMap="Normal/AllShopsResponse/Shop">
        SELECT
            # shops
            t1.id AS `shops.id`,
            t1.`name` AS `shops.name`,
            t1.phone AS `shops.phone`,
            t1.delivery AS `shops.delivery`,
            t1.pay_card AS `shops.pay_card`,
            t1.pay_bank AS `shops.pay_bank`,

            # shop_opens
            t2.day_of_week AS `shop_opens.day_of_week`,
            t2.closed AS `shop_opens.closed`,
            t2.open_time AS `shop_opens.open_time`,
            t2.close_time AS `shop_opens.close_time`,

            # shop_categories
            t4.id AS `shop_categories.id`

        FROM (
            # shops
            SELECT *
            FROM koin.shops
            WHERE is_deleted = 0
        ) t1

        # shops : shop_opens (1:N)
        LEFT JOIN koin.shop_opens t2
        ON
            t1.id = t2.shop_id
            AND t2.is_deleted = 0

        # relation table between shop and shop_categories
        LEFT JOIN koin.shop_category_map t3
        ON
            t1.id = t3.shop_id
            AND t3.is_deleted = 0

        # shops : shop_categories (N:M)
        LEFT JOIN koin.shop_categories t4
        ON
            t3.shop_category_id = t4.id
            AND t4.is_deleted = 0
    </select>

    <resultMap id="Normal/AllShopsResponse/Shop" type="koreatech.in.dto.shop.normal.response.AllShopsResponse$Shop">
        <id property="id" column="shops.id"/>
        <result property="name" column="shops.name"/>
        <result property="phone" column="shops.phone"/>
        <result property="delivery" column="shops.delivery"/>
        <result property="pay_card" column="shops.pay_card"/>
        <result property="pay_bank" column="shops.pay_bank"/>

        <collection property="open" javaType="list" ofType="koreatech.in.dto.shop.normal.response.AllShopsResponse$Shop$Open">
            <result property="day_of_week" column="shop_opens.day_of_week"/>
            <result property="closed" column="shop_opens.closed"/>
            <result property="open_time" column="shop_opens.open_time"/>
            <result property="close_time" column="shop_opens.close_time"/>
        </collection>

        <collection property="category_ids" javaType="list" ofType="integer">
            <id property="category_id" column="shop_categories.id"/>
        </collection>
    </resultMap>


    <!-- Shops in ShopsResponse For Admin -->
    <select id="getShopsInShopsResponseByConditionForAdmin" resultMap="Admin/ShopsResponse/Shop">
        SELECT
            # shops
            t1.id AS `shops.id`,
            t1.`name` AS `shops.name`,
            t1.phone  AS `shops.phone`,
            t1.is_deleted AS `shops.is_deleted`,

            # shop_categories
            t3.name AS `shop_categories.name`

        FROM (
            SELECT *
            FROM koin.shops

            <trim prefix="WHERE" prefixOverrides="AND">
                <!-- 검색 -->
                <if test="condition.query != null">
                    <trim prefix="AND">
                        <if test='condition.searchType.name().equals("NAME")'>
                            internal_name
                        </if>
                        LIKE CONCAT('%', REPLACE(#{condition.query}, ' ', ''), '%')
                    </trim>
                </if>

                <!-- 필터링 -->
                <if test="!condition.filter.isEmpty()">
                    <trim prefix="AND">
                        <foreach collection="condition.filter" item="item" separator="AND">
                            <if test='item.name().equals("IS_DELETED")'> is_deleted = 1 </if>
                            <if test='item.name().equals("DELIVERY")'> delivery = 1 </if>
                            <if test='item.name().equals("PAY_CARD")'> pay_card = 1 </if>
                            <if test='item.name().equals("PAY_BANK")'> pay_bank = 1 </if>
                        </foreach>
                    </trim>
                </if>
            </trim>

            <!-- 정렬 -->
            <if test="condition.sort != null">
                <trim prefix="ORDER BY">
                    <if test='condition.sort.name().equals("NAME_ASC")'> `name` ASC </if>
                    <if test='condition.sort.name().equals("NAME_DESC")'> `name` DESC </if>
                    <if test='condition.sort.name().equals("CREATED_AT_ASC")'> created_at ASC </if>
                    <if test='condition.sort.name().equals("CREATED_AT_DESC")'> created_at DESC </if>
                </trim>
            </if>

            <!-- 페이지네이션 -->
            LIMIT #{begin}, #{condition.limit}
        ) t1

            # relation table between shops and shop_categories
            LEFT JOIN koin.shop_category_map t2
            ON
                t1.id = t2.shop_id
                AND t2.is_deleted = 0

            # shops : shop_categories (N:M)
            LEFT JOIN koin.shop_categories t3
            ON
                t2.shop_category_id = t3.id
                AND t3.is_deleted = 0
    </select>

    <select id="getTotalCountOfShopsByConditionForAdmin" parameterType="koreatech.in.dto.shop.admin.request.ShopsCondition" resultType="integer">
        SELECT COUNT(*)
        FROM koin.shops

        <trim prefix="WHERE" prefixOverrides="AND">
            <!-- 검색 -->
            <if test="condition.query != null">
                <trim prefix="AND">
                    <if test='condition.searchType.name().equals("NAME")'>
                        internal_name
                    </if>
                    LIKE CONCAT('%', REPLACE(#{condition.query}, ' ', ''), '%')
                </trim>
            </if>

            <!-- 필터링 -->
            <if test="!condition.filter.isEmpty()">
                <trim prefix="AND">
                    <foreach collection="condition.filter" item="item" separator="AND">
                        <if test='item.name().equals("IS_DELETED")'> is_deleted = 1 </if>
                        <if test='item.name().equals("DELIVERY")'> delivery = 1 </if>
                        <if test='item.name().equals("PAY_CARD")'> pay_card = 1 </if>
                        <if test='item.name().equals("PAY_BANK")'> pay_bank = 1 </if>
                    </foreach>
                </trim>
            </if>
        </trim>
    </select>

    <resultMap id="Admin/ShopsResponse/Shop" type="koreatech.in.dto.shop.admin.response.ShopsResponse$Shop">
        <id property="id" column="shops.id"/>
        <result property="name" column="shops.name"/>
        <result property="phone" column="shops.phone"/>
        <result property="is_deleted" column="shops.is_deleted"/>
        <collection property="category_names" javaType="list" ofType="string">
            <result property="category_name" column="shop_categories.name"/>
        </collection>
    </resultMap>
</mapper>